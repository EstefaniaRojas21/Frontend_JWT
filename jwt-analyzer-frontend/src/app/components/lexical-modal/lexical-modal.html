<div class="modal-backdrop" (click)="close()"></div>

<div class="modal-window" (click)="$event.stopPropagation()">
  <h2 class="modal-title">ğŸ” AnÃ¡lisis de JWT</h2>

  <!-- âœ… NAV de fases -->
  <div class="phase-switch">
    <button 
      class="phase-btn" 
      [class.active]="currentPhase === 'lexico'" 
      (click)="switchPhase('lexico')">
      ğŸŸ¦ LÃ©xico
    </button>
    <button 
      class="phase-btn" 
      [class.active]="currentPhase === 'sintactico'" 
      (click)="switchPhase('sintactico')">
      ğŸŸ© SintÃ¡ctico
    </button>
    <button 
      class="phase-btn" 
      [class.active]="currentPhase === 'semantico'" 
      (click)="switchPhase('semantico')">
      ğŸŸ¨ SemÃ¡ntico
    </button>
  </div>

  <!-- âœ… Contenido scrolleable -->
  <div class="modal-content">
    <div *ngIf="result" class="pretty-box">
      
      <!-- ========== FASE LÃ‰XICO ========== -->
      <div *ngIf="currentPhase === 'lexico'">
        
        <!-- REPORTE DE ANÃLISIS -->
        <div *ngIf="result.reporte_analisis_lexico" class="section section-report">
          <h3>ğŸ“‹ Reporte de AnÃ¡lisis LÃ©xico</h3>
          <div class="report-content">
            <pre class="report-text">{{ result.reporte_analisis_lexico }}</pre>
          </div>
        </div>


        <!-- ALFABETO -->
        <div *ngIf="result.alfabeto" class="section">
          <h3>ğŸ“Œ Alfabeto Reconocido</h3>

          <!-- NotaciÃ³n formal -->
          <div class="formal-notation">
            <p><strong>Base64URL:</strong> {{ '{' }} Aâ€“Z, aâ€“z, 0â€“9, '-', '_' {{ '}' }}</p>
            <p><strong>Delimitador JWT:</strong> {{ '{' }} '.' {{ '}' }}</p>
            <p><strong>Alfabeto Total:</strong> {{ '{' }} Aâ€“Z âˆª aâ€“z âˆª 0â€“9 âˆª '-' âˆª '_' âˆª '.' {{ '}' }}</p>

          </div>

          <!-- Tabla de desglose -->
          <table class="alphabet-table">
            <thead>
              <tr>
                <th>CategorÃ­a</th>
                <th>SÃ­mbolos</th>
                <th>Cantidad</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Letras mayÃºsculas</td>
                <td>Aâ€“Z</td>
                <td>26</td>
              </tr>
              <tr>
                <td>Letras minÃºsculas</td>
                <td>aâ€“z</td>
                <td>26</td>
              </tr>
              <tr>
                <td>DÃ­gitos</td>
                <td>0â€“9</td>
                <td>10</td>
              </tr>
              <tr>
                <td>SÃ­mbolos</td>
                <td>' - ', ' _ '</td>
                <td>2</td>
              </tr>
              <tr class="total-row">
                <td><strong>Total Base64URL</strong></td>
                <td></td>
                <td><strong>64</strong></td>
              </tr>
              <tr>
                <td>Delimitador JWT</td>
                <td>'.'</td>
                <td>1</td>
              </tr>
              <tr class="total-row">
                <td><strong>Total Alfabeto</strong></td>
                <td></td>
                <td><strong>65</strong></td>
              </tr>
            </tbody>
          </table>
        </div>


        <!-- TOKENS -->
        <div *ngIf="result.tokens?.length" class="section">
          <h3>ğŸ”¤ Tokens Identificados ({{ result.tokens.length }})</h3>
          <div class="token-list">
            <div class="token-card" *ngFor="let t of result.tokens; let i = index">
              <div class="token-header">
                <span class="token-number">#{{ i + 1 }}</span>
                <span class="token-type" [ngClass]="getTokenClass(t.tipo)">{{ t.tipo }}</span>
              </div>
              <div class="token-value">{{ truncateValue(t.valor, 80) }}</div>
              <div class="token-meta">
                LÃ­nea {{ t.linea }} | Columna {{ t.columna }} | Longitud {{ t.longitud || t.valor?.length || 0 }}
              </div>
            </div>
          </div>
        </div>


        

        <!-- ERRORES LÃ‰XICOS -->
        <div *ngIf="result.errores?.length" class="section section-error">
          <h3>âŒ Errores LÃ©xicos ({{ result.errores.length }})</h3>
          <div class="error-card" *ngFor="let e of result.errores">
            {{ e }}
          </div>
        </div>

        <!-- ADVERTENCIAS LÃ‰XICAS -->
        <div *ngIf="result.advertencias?.length" class="section section-warn">
          <h3>âš ï¸ Advertencias ({{ result.advertencias.length }})</h3>
          <div class="warn-card" *ngFor="let w of result.advertencias">
            {{ w }}
          </div>
        </div>

      </div>

      <div *ngIf="currentPhase === 'sintactico'">

      <!-- VALIDACIÃ“N SINTÃCTICA -->
      <div *ngIf="result.valido !== undefined" class="section">
        <h3>âœ… ValidaciÃ³n SintÃ¡ctica</h3>
        <div class="validation-result" [class.valid]="result.valido" [class.invalid]="!result.valido">
          <span *ngIf="result.valido">âœ… Sintaxis VÃ¡lida</span>
          <span *ngIf="!result.valido">âŒ Sintaxis InvÃ¡lida</span>
        </div>
      </div>


      <!-- DERIVACIONES -->
      <!-- DERIVACIONES -->
      <div *ngIf="result.derivaciones?.length" class="section">
        <h3>ğŸ“ Derivaciones Paso a Paso</h3>
        <div *ngFor="let paso of result.derivaciones" class="derivation-step">
          {{ paso }}
        </div>
      </div>



      <!-- ÃRBOL SINTÃCTICO -->
      <div *ngIf="result.arbol_sintactico" class="section">
        <h3>ğŸŒ² Ãrbol SintÃ¡ctico</h3>
        <pre class="json-display">{{ result.arbol_sintactico | json }}</pre>
      </div>

      <!-- ERRORES SINTÃCTICOS -->
      <div *ngIf="result.errores?.length" class="section section-error">
        <h3>âŒ Errores SintÃ¡cticos ({{ result.errores.length }})</h3>
        <div class="error-card" *ngFor="let e of result.errores">
          {{ e }}
        </div>
      </div>

    </div>


      <!-- ========== FASE SEMÃNTICO ========== -->
      <div *ngIf="currentPhase === 'semantico'">
        
        <!-- TABLA DE SÃMBOLOS -->
        <div *ngIf="result.tabla_simbolos" class="section">
        <h3>ğŸ“‹ Tabla de SÃ­mbolos</h3>

        <table class="symbol-table">
          <thead>
            <tr>
              <th>Componente</th>
              <th>Nombre</th>
              <th>Tipo</th>
              <th>Valor</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of result.tabla_simbolos">
              <td class="badge" [ngClass]="item.componente">{{ item.componente }}</td>
              <td>{{ item.nombre }}</td>
              <td>{{ item.tipo }}</td>
              <td>{{ item.valor }}</td>
            </tr>
          </tbody>
        </table>
      </div>


        <!-- VALIDACIÃ“N TEMPORAL -->
        <div *ngIf="result.validacion_tiempo" class="section">
        <h3>â° ValidaciÃ³n Temporal</h3>

        <div class="val-box">
          <div class="val-item">
            <span class="val-label">Estado:</span>
            <span class="val-value estado" [ngClass]="{
              'ok': result.validacion_tiempo.estado.includes('âœ…'),
              'warn': result.validacion_tiempo.estado.includes('âš ï¸'),
              'error': result.validacion_tiempo.estado.includes('âŒ')
            }">
              {{ result.validacion_tiempo.estado }}
            </span>
          </div>

          <div class="val-item">
            <span class="val-label">Fecha Actual:</span>
            <span class="val-value">{{ result.validacion_tiempo.fecha_actual }}</span>
          </div>

          <div class="val-item">
            <span class="val-label">Fecha de EmisiÃ³n (iat):</span>
            <span class="val-value">{{ result.validacion_tiempo.fecha_emision }}</span>
          </div>

          <div class="val-item">
            <span class="val-label">Fecha de ExpiraciÃ³n (exp):</span>
            <span class="val-value">{{ result.validacion_tiempo.fecha_expiracion }}</span>
          </div>
        </div>

        <div class="detalles-box">
          <h4>Detalles:</h4>

          <div *ngFor="let d of result.validacion_tiempo.detalles"
              class="detalle-item">
            {{ d }}
          </div>
        </div>
      </div>


        <!-- ERRORES SEMÃNTICOS -->
        <div *ngIf="result.errores?.length" class="section section-error">
          <h3>âŒ Errores SemÃ¡nticos ({{ result.errores.length }})</h3>
          <div class="error-card" *ngFor="let e of result.errores">
            {{ e }}
          </div>
        </div>

      </div>

      <!-- SI NO HAY DATOS -->
      <div *ngIf="!hasAnyData()" class="section section-empty">
        <p>â³ Cargando datos de {{ currentPhase }}...</p>
      </div>

    </div>
  </div>

  <!-- âœ… BotÃ³n cerrar -->
  <button class="btn-close" (click)="close()">Cerrar</button>
</div>